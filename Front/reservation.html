<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Computer Reservation</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 900px; margin: 20px auto; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; }
    .nav { text-align: center; margin-bottom: 20px; }
    .nav a { margin: 0 5px; padding: 8px 16px; background: #007bff; color: #fff; text-decoration: none; border-radius: 4px; }
    .nav a:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    input[type="number"] { width: 60px; }
    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Computer Reservation</h2>
    <div class="nav">
      <a href="home.html">üè† Home</a>
      <a href="cart.html">üõí Cart</a>
      <a href="sessions.html">‚åõ Sessions</a>
    </div>
    <div id="computer-list"></div>
    <div id="reservation-message" class="toast"></div>
  </div>

  <script>
    const baseURL = 'http://localhost:8000';
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) { window.location.href = 'login.html'; }

    // Fetch computers from backend
    async function fetchComputers() {
      try {
        const res = await fetch(`${baseURL}/computers`);
        const data = await res.json();
        displayComputers(data);
      } catch (error) {
        console.error('Error fetching computers:', error);
      }
    }

    function displayComputers(computers) {
      let html = `<table>
        <thead>
          <tr>
            <th>Computer Name</th>
            <th>Status</th>
            <th>Price/Hour</th>
            <th>Hours</th>
            <th>Total Price</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>`;
      computers.forEach((comp, index) => {
         // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô "Computer {index+1}"
         const compName = comp.name || `Computer ${index+1}`;
         // ‡∏ñ‡πâ‡∏≤ status ‡πÄ‡∏õ‡πá‡∏ô "Available" ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "Empty"
         const statusText = (comp.status === "Available") ? "Empty" : comp.status;
         const disabled = (statusText === "Empty") ? "" : "disabled";
         html += `<tr id="comp-${comp.id}">
            <td>${compName}</td>
            <td id="status-${comp.id}">${statusText}</td>
            <td>${comp.price_per_hour || 50}</td>
            <td>
              <input type="number" id="hours-${comp.id}" value="1" min="1" onchange="updatePrice(${comp.id}, ${comp.price_per_hour || 50})">
            </td>
            <td id="price-${comp.id}">${comp.price_per_hour || 50}</td>
            <td>
              <button onclick="reserveComputer(${comp.id}, '${compName}', ${comp.price_per_hour || 50})" ${disabled}>Reserve</button>
            </td>
         </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('computer-list').innerHTML = html;
    }

    function updatePrice(compId, pricePerHour) {
      const hours = parseInt(document.getElementById(`hours-${compId}`).value) || 1;
      const discount = (hours > 1) ? Math.min((hours - 1) * 5, 45) : 0;
      const total = pricePerHour * hours * (1 - discount/100);
      document.getElementById(`price-${compId}`).textContent = total.toFixed(2);
    }

    function showToast(message) {
      const toast = document.getElementById('reservation-message');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    async function reserveComputer(compId, compName, pricePerHour) {
      const hours = parseInt(document.getElementById(`hours-${compId}`).value) || 1;
      const discount = (hours > 1) ? Math.min((hours - 1) * 5, 45) : 0;
      const total = pricePerHour * hours * (1 - discount/100);
      const now = new Date();
      const start_time = now.toISOString();
      const end_time = new Date(now.getTime() + hours * 60 * 60 * 1000).toISOString();
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î deadline 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ (300,000 ms)
      const deadline = now.getTime() + 300000;
      const reservationData = {
         UserId: user.id,
         ComputerId: compId,
         hours,
         discount,
         total_price: total.toFixed(2),
         status: "pending",
         reservation_time: now.toISOString(),
         start_time,
         end_time,
         deadline
      };

      try {
         const res = await fetch(`${baseURL}/reservations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reservationData)
         });
         const data = await res.json();
         if (res.ok) {
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô UI ‡πÄ‡∏õ‡πá‡∏ô Pending ‡πÅ‡∏•‡∏∞ disable ‡∏õ‡∏∏‡πà‡∏° Reserve
            document.getElementById(`status-${compId}`).textContent = "Pending";
            document.querySelector(`#comp-${compId} button`).disabled = true;
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å reservation ‡πÉ‡∏ô Cart ‡∏û‡∏£‡πâ‡∏≠‡∏° deadline
            addToCart({ type: 'reservation', data: { ...data, deadline } });
            showToast(`Reserved ${compName}. Time left: 5:00`);
            // ‡∏ï‡∏±‡πâ‡∏á timer ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å reservation ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞
            setTimeout(() => { cancelReservation(data.id, compId); }, 300000);
         } else {
            showToast(data.error || 'Reservation failed!');
         }
      } catch (error) {
         showToast('Error: ' + error.message);
      }
    }

    async function cancelReservation(reservationId, compId) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      const index = cart.findIndex(item => item.type === 'reservation' && item.data.id === reservationId);
      if (index !== -1) {
         try {
            const res = await fetch(`${baseURL}/reservations/${reservationId}`, {
               method: 'PUT',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ status: "empty" })
            });
            if (res.ok) {
               document.getElementById(`status-${compId}`).textContent = "Empty";
               showToast(`Reservation canceled due to timeout.`);
               cart.splice(index, 1);
               localStorage.setItem('cart', JSON.stringify(cart));
               // Re-enable Reserve button
               document.querySelector(`#comp-${compId} button`).disabled = false;
            }
         } catch (error) {
            console.error('Error canceling reservation:', error);
         }
      }
    }

    function addToCart(item) {
       let cart = JSON.parse(localStorage.getItem('cart')) || [];
       cart.push(item);
       localStorage.setItem('cart', JSON.stringify(cart));
    }

    fetchComputers();
  </script>
</body>
</html>
