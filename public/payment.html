<!-- payment.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Payment</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 600px; margin: 20px auto; background: #fff; border-radius: 8px; padding: 20px; 
                 box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; position: relative; }
    select, button { padding: 10px; margin: 10px; }
    .qr { margin-top: 20px; }
    /* Fixed navigation buttons */
    .top-left-button {
      position: fixed; top: 20px; left: 20px; background: #007bff; color: #fff; padding: 10px 16px; 
      border-radius: 4px; text-decoration: none;
    }
    .bottom-right-button {
      position: fixed; bottom: 20px; right: 20px; background: #555; color: #fff; padding: 10px 16px; 
      border-radius: 4px; border: none; cursor: pointer;
    }
  </style>
</head>
<body>
  <a href="cart.html" class="top-left-button">üõí Cart</a>
  <button class="bottom-right-button" onclick="goBack()">Back</button>
  
  <div class="container">
    <h2>Payment</h2>
    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</p>
    <select id="payment-method">
      <option value="qr">QR Code</option>
      <option value="credit">Credit Card</option>
      <option value="cash">Cash</option>
    </select>
    <div>
      <button onclick="confirmPayment()">üí≥ Confirm Payment</button>
      <button onclick="cancelPayment()">Cancel Payment</button>
    </div>
    <div class="qr" id="qr-code" style="display:none;">
      <img src="https://via.placeholder.com/150?text=QR+Code" alt="QR Code">
    </div>
  </div>
  
  <script>
    const baseURL = 'https://netcafe-production.up.railway.app';
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) { window.location.href = 'login.html'; }
    
    function goBack() {
      window.history.back();
    }
    
    function cancelPayment() {
      alert("Payment canceled");
      window.location.href = "cart.html";
    }
    
    async function processPayment() {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      let updatedReservations = [];
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Reservation ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Cart
      for (let item of cart) {
        if(item.type === 'reservation'){
          try {
            const res = await fetch(`${baseURL}/reservations/${item.data.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: "already reserved" })
            });
            if(res.ok){
              updatedReservations.push(item.data);
            }
          } catch (error) {
            console.error('Error updating reservation:', error);
          }
        }
      }
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Reservation ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏£‡πâ‡∏≤‡∏á Session ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      for (let resData of updatedReservations) {
        try {
          const sessionData = {
            user_id: user.id,
            computer_id: resData.ComputerId, // ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á ComputerId ‡∏à‡∏≤‡∏Å Reservation
            start_time: resData.start_time,
            end_time: resData.end_time
          };
          await fetch(`${baseURL}/sessions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(sessionData)
          });
        } catch (error) {
          console.error('Error creating session:', error);
        }
      }
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (receipt) ‡πÇ‡∏î‡∏¢‡∏ô‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Cart ‡∏°‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô
      const receipt = {
        user: user,
        date: new Date().toLocaleString(),
        items: cart,
        total: cart.reduce((sum, item) => sum + parseFloat(item.data.total_price), 0).toFixed(2)
      };
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏•‡∏á‡πÉ‡∏ô order history (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage)
      let orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
      orderHistory.push(receipt);
      localStorage.setItem('orderHistory', JSON.stringify(orderHistory));
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Cart
      localStorage.removeItem('cart');
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ receipt
      localStorage.setItem('currentReceipt', JSON.stringify(receipt));
      window.location.href = 'receipt.html';
    }
    
    async function confirmPayment() {
      const method = document.getElementById('payment-method').value;
      if(method === "qr") {
        document.getElementById('qr-code').style.display = "block";
      }
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô processPayment ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Session
      await processPayment();
    }
  </script>
</body>
</html>
